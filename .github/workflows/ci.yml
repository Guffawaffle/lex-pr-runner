name: CI

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm run typecheck

  test:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm test

  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm run build --if-present

  determinism:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm run build --if-present
      - run: npm run format
      - name: Check for changes after build and format
        run: |
          if ! git diff --exit-code; then
            echo "❌ Repository is not clean after build and format"
            echo "The following files have changes:"
            git diff --name-only
            echo ""
            echo "Please run 'npm run build && npm run format' locally and commit the changes."
            exit 1
          else
            echo "✅ Repository is clean after build and format"
          fi
      - name: Determinism smoke test - compare two plan runs
        run: |
          rm -rf .artifactsA .artifactsB
          node dist/cli.js plan --out .artifactsA
          node dist/cli.js plan --out .artifactsB
          if ! diff -u .artifactsA/plan.json .artifactsB/plan.json; then
            echo "❌ Plan output is not deterministic"
            exit 1
          fi
          if ! diff -u .artifactsA/snapshot.md .artifactsB/snapshot.md; then
            echo "❌ Snapshot output is not deterministic"
            exit 1
          fi
          echo "✅ Plan generation is deterministic"
