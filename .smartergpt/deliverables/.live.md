# Deliverables â€” .live.md

## 1) Executive Summary

Implemented plan artifacts emission feature for lex-pr-runner. The `lex-pr plan` command now generates both `plan.json` and `snapshot.md` with deterministic, hash-stable content. Added topological sorting to compute execution levels, content hashing for stability, and human-readable snapshot generation.

## 2) Steps Taken

- **Updated Plan Schema**: Extended Plan type to include `levels` and `contentHash` fields
- **Implemented Topological Sorting**: Created TypeScript port of Python toposort logic with Kahn's algorithm
- **Added Content Hashing**: Implemented SHA-256 hashing for deterministic plan stability
- **Created Snapshot Generation**: Built markdown generator with required sections (Inputs, Levels, Items table, Notes)
- **Updated CLI Command**: Modified plan command to write both plan.json and snapshot.md
- **Added ESLint Configuration**: Set up TypeScript-aware linting with proper parser
- **Updated Documentation**: Revised README to reflect new functionality and artifacts

## 3) Evidence & Verification

### CLI Command Output
```bash
$ npm run cli -- plan
Wrote .smartergpt/runner/plan.json
Wrote .smartergpt/runner/snapshot.md
```

### Generated plan.json
```json
{
  "target": "main",
  "items": [
    {
      "id": 1,
      "branch": "feat/a", 
      "needs": [],
      "strategy": "rebase-weave"
    },
    {
      "id": 2,
      "branch": "feat/b",
      "needs": [1],
      "strategy": "rebase-weave"
    }
  ],
  "levels": [
    [1],
    [2]
  ],
  "contentHash": "d60d5f54931d19be98b799fc9ed158060e6a0716656d3afc630e27bf0efd2218"
}
```

### Generated snapshot.md
```markdown
# Runner Snapshot

## Inputs
- Target: `main`
- Items count: 2
- Content hash: `d60d5f54931d19be98b799fc9ed158060e6a0716656d3afc630e27bf0efd2218`

## Levels
Level 0: [1]
Level 1: [2]

## Items
| id | branch | sha | needs | strategy |
|---|---|---|---|---|
| 1 | feat/a | (current) | (none) | rebase-weave |
| 2 | feat/b | (current) | 1 | rebase-weave |

## Notes
- Plan computed with deterministic topological sorting
- Levels indicate execution order (items in same level can run in parallel)
- Content hash ensures plan stability for unchanged inputs
```

### Idempotence Test Results
```bash
Testing idempotence...
First run completed
Second run completed

Comparing plan.json files...
âœ… plan.json files are identical

Comparing snapshot.md files...
âœ… snapshot.md files are identical

ðŸŽ‰ Idempotence test passed! Artifacts are hash-stable.
```

### Type Checking and Linting
```bash
$ npm run typecheck
# No errors

$ npm run lint 
# No errors
```

## 4) Final Results

**Meets Acceptance? YES**

âœ… **All Tasks Completed:**
- [x] Write plan.json with target, items[], levels, and content hash
- [x] Generate snapshot.md with sections: Inputs, Levels, Items table, Notes  
- [x] Idempotence test: regenerate artifacts and compare byte-for-byte
- [x] Re-running `lex-pr plan` with unchanged inputs yields identical artifacts (hash-stable)

The implementation successfully provides deterministic plan artifacts that are stable across multiple runs with unchanged inputs.

## 5) Files Changed

**NEW FILES:**
- `src/core/toposort.ts` - Topological sorting implementation
- `src/core/snapshot.ts` - Snapshot markdown generation
- `eslint.config.js` - ESLint configuration  
- `test-idempotence.js` - Idempotence verification script

**MODIFIED FILES:**
- `src/core/plan.ts` - Extended Plan schema, added levels/hash computation
- `src/cli.ts` - Updated plan command to write both artifacts
- `README.md` - Updated documentation for new functionality

**GENERATED ARTIFACTS:**
- `.smartergpt/runner/plan.json` - Machine-readable plan
- `.smartergpt/runner/snapshot.md` - Human-readable snapshot