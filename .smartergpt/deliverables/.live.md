# lex-pr-runner — TypeScript Implementation Report# lex-pr-runner — TypeScript Implementation Report



*Generated: September 27, 2025**Generated: September 27, 2025*



## 1. Executive Summary## 1. Executive Summary



Successfully completed the TypeScript-first implementation of lex-pr-runner, stepping back to "Gate 0" scope to establish a deterministic and clean core. The implementation provides schema validation, merge-order computation via DAG, and gate execution with local command running. All acceptance criteria have been met with comprehensive test coverage.Successfully completed the TypeScript-first implementation of lex-pr-runner, stepping back to "Gate 0" scope to establish a deterministic and clean core. The implementation provides schema validation, merge-order computation via DAG, and gate execution with local command running. All acceptance criteria have been met with comprehensive test coverage.



**Outcome:** ✅ **Complete Success****Outcome:** ✅ **Complete Success**

- TypeScript core implemented with modular architecture- TypeScript core implemented with modular architecture

- Schema validation with Zod (strict mode)- Schema validation with Zod (strict mode)

- Deterministic merge order computation using Kahn's algorithm- Deterministic merge order computation using Kahn's algorithm

- Gate execution with timeout, environment, and output capture- Gate execution with timeout, environment, and output capture

- Comprehensive test suite with Vitest (25 tests passing)- Comprehensive test suite with Vitest (25 tests passing)

- CLI supporting both TTY and JSON modes- CLI supporting both TTY and JSON modes

| 10 | Implement CLI command with --json flag, error handling, and deterministic artifacts | no | 7 | MERGEABLE |  |  |

## 2. Steps Taken| 11 | Implement GitHub query fallback via scope.yml for PR discovery | no | 11 | MERGEABLE |  |  |

| 12 | Implement determinism tests and harness with snapshot generation | no | 15 | MERGEABLE |  |  |

### **T1 - Code Organization Refactor**| 13 | Emit plan artifacts (plan.json + snapshot.md) | yes | 11 | MERGEABLE |  |  |

- Split monolithic `src/core/plan.ts` into focused modules:| 14 | Implement dependency DAG builder and levelization with Kahn's algorithm | yes | 16 | MERGEABLE |  |  |

  - `src/schema.ts` - Zod schema validation and loading| 15 | Implement canonical input loader with precedence for stack.yml, scope.yml, and deps.yml | yes | 9 | MERGEABLE |  |  |

  - `src/mergeOrder.ts` - DAG computation with Kahn's algorithm  | 16 | Implement MCP tool adapter with plan.create and resource access | yes | 9 | MERGEABLE |  |  |

  - `src/gates.ts` - Local command execution and result capture| 17 | Implement doctor checks for environment sanity | yes | 4 | MERGEABLE |  |  |

- Updated CLI imports to use new modular structure

- Preserved legacy Python code in `legacy/py-prototype/` for reference## Steps Taken — Gate 1



### **T2 - Structured Fixture Creation** _Run: 2025-09-27 18:56:12Z_

- Created comprehensive test fixtures in `tests/fixtures/`:- Created/updated worktrees under `.smartergpt/runner/wt/` for each PR head.

  - `plan.tiny.json` - Linear dependencies (3 nodes)- Detected gates (ruff, mypy, pytest) and executed with timeouts (600s).

  - `plan.parallel.json` - Multiple parallelizable groups (6 nodes)- Wrote gate artifacts to `.smartergpt/gate-results/pr-<n>-<gate>.json`.

  - `plan.bad-unknown-dep.json` - Unknown dependency error case- Summarized local gates and remote checks; updated readiness.

  - `plan.cycle.json` - Circular dependency error case

  - `plan.gates.json` - Mixed passing/failing gates## Evidence & Verification — Local Gates

  - `plan.bad-schema.json` - Invalid schema error case

| PR | ruff | mypy | pytest | remote | readiness |

### **T3 - Comprehensive Testing with Vitest**|---:|:-----|:-----|:-------|:-------|:----------|

- Added Vitest testing framework to `package.json`| #10 | skipped | skipped | fail | none | NOT READY (local gates failing) |

- Created `vitest.config.ts` with Node environment| #11 | skipped | skipped | fail | none | NOT READY (local gates failing) |

- Implemented unit tests for all modules:| #12 | skipped | skipped | fail | none | NOT READY (local gates failing) |

  - Schema validation (6 tests)| #13 | skipped | skipped | fail | none | NOT READY (draft, local gates failing) |

  - Merge order computation (7 tests) | #14 | skipped | skipped | fail | none | NOT READY (draft, local gates failing) |

  - Gate execution (9 tests)| #15 | skipped | skipped | fail | none | NOT READY (draft, local gates failing) |

- Added `npm run test` and `npm run test:run` scripts| #16 | skipped | skipped | fail | none | NOT READY (draft, local gates failing) |

| #17 | skipped | skipped | fail | none | NOT READY (draft, local gates failing) |

### **T4 - CLI Interface Improvements**

- Enhanced CLI to support both `--plan <file>` flag and positional arguments## Gate 1 Summary

- Added JSON output modes for all commands

- Improved error handling with detailed messages- Gate 1 summary: **0/8 READY**, **8 NOT READY** as of 2025-09-27 18:56:12Z.

- Added item/level filtering for gate command

## Executive Summary — Gate 2

### **T5 - Package.json Updates**

- Added Vitest dependency and test scripts**Executive Summary — Gate 2**

- Ensured Node 20+ compatibility

- Maintained pnpm-first approach with npm fallbackTagline: Fan-out tasks as multiple PRs in parallel, then build a merge pyramid from the blocks. Compute dependency order, run gates locally, and merge cleanly.



## 3. Evidence & Verification- Total open PRs: **8**

- READY: **0**, NOT READY: **8**

### **Build Results**- Levels in merge pyramid: **1**

```bash- Base branch (inferred): **main**

$ npm run build

> lex-pr-runner@0.1.0 build

> tsup src/cli.ts --format esm,cjs --dts --out-dir dist && tsup src/mcp/server.ts --format esm,cjs --dts --out-dir dist## Evidence & Verification — Merge Pyramid



CLI Building entry: src/cli.ts**Level 1** (weave order: changedFiles ?, PR# ?)

CLI Using tsconfig: tsconfig.json

CLI tsup v8.5.0| PR | Title | Ready | Deps |

CLI Target: es2022|---:|:------|:------|:-----|

ESM Build start| #17 | Implement doctor checks for environment sanity | NOT READY | — |

CJS Build start| #10 | Implement CLI command with --json flag, error handling, and deterministic artifacts | NOT READY | — |

ESM dist/cli.js 11.08 KB| #15 | Implement canonical input loader with precedence for stack.yml, scope.yml, and deps.yml | NOT READY | — |

ESM ⚡️ Build success in 21ms| #16 | Implement MCP tool adapter with plan.create and resource access | NOT READY | — |

CJS dist/cli.cjs 12.47 KB| #11 | Implement GitHub query fallback via scope.yml for PR discovery | NOT READY | — |

CJS ⚡️ Build success in 22ms| #13 | Emit plan artifacts (plan.json + snapshot.md) | NOT READY | — |

DTS Build start| #12 | Implement determinism tests and harness with snapshot generation | NOT READY | — |

DTS ⚡️ Build success in 986ms| #14 | Implement dependency DAG builder and levelization with Kahn's algorithm | NOT READY | — |

DTS dist/cli.d.ts  20.00 B

DTS dist/cli.d.cts 20.00 B

```## Final Results — Gate 2



### **Test Suite Results****Final Results — Gate 2**

```bash

$ npm run test:run tests/- This was a **dry-run simulation**. No merges were performed.

> lex-pr-runner@0.1.0 test:run- Machine-readable plan written to `./.smartergpt/deliverables/merge-plan.json`.

> vitest run tests/- Use this plan to drive a weave-merge execution when all blocking items are ready.



 RUN  v2.1.9 /home/guff/lex-pr-runner

## Executive Summary — Gate 3

 ✓ tests/gates.test.ts (9)

 ✓ tests/mergeOrder.test.ts (7)**Gate 3 — Weave Rehearsal Summary** (_2025-09-27 19:08:23Z_)

 ✓ tests/schema.test.ts (6)

- Base branch: **main**

 Test Files  4 passed (4)- Attempted: **8**, Merged cleanly: **1**, Conflicts: **7**, Skipped: **0**

      Tests  25 passed (25)- Dry-run merges performed on ephemeral branch; no pushes.

   Start at  15:04:14

   Duration  1.01s (transform 174ms, setup 0ms, collect 274ms, tests 339ms, environment 1ms, prepare 457ms)

```## Evidence & Verification — Weave Rehearsal



### **CLI Command Verification**| PR | Action | Status | Conflicts | Post-merge ruff | mypy | pytest | Commit |

|---:|:-------|:-------|:----------|:----------------|:-----|:-------|:-------|

#### Schema Validation| #10 | merge | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts | skipped | skipped | skipped |  |

```bash| #11 | merge | conflict | .smartergpt/deliverables/.live.md | skipped | skipped | skipped |  |

$ npm run cli -- schema validate tests/fixtures/plan.tiny.json| #12 | merge | conflict | .smartergpt/deliverables/.live.md, src/cli.ts | skipped | skipped | skipped |  |

✓ tests/fixtures/plan.tiny.json is valid| #13 | merge | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts | skipped | skipped | skipped |  |

| #14 | merge | conflict | .smartergpt/deliverables/.live.md, src/cli.ts | skipped | skipped | skipped |  |

$ npm run cli -- schema validate tests/fixtures/plan.bad-schema.json| #15 | merge | conflict | .smartergpt/deliverables/.live.md | skipped | skipped | skipped |  |

✗ tests/fixtures/plan.bad-schema.json validation failed:| #16 | merge | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts | skipped | skipped | skipped |  |

  items: Expected array, received string| #17 | merge | merged | — | skipped | skipped | fail | 5bc0772 |

```

## Final Results — Gate 3

#### Merge Order Computation

```bash**Final Results — Gate 3**

$ npm run cli -- merge-order --plan tests/fixtures/plan.parallel.json --json

{"levels":[["feat-a","feat-b","feat-f"],["feat-c","feat-d"],["feat-e"]]}- This was a **dry-run**; no merges were pushed.

- Use conflict lists to queue fix-forward commits in the respective PRs, then re-run Gates 1–3.

$ npm run cli -- merge-order tests/fixtures/plan.cycle.json

Error computing merge order: dependency cycle detected involving: feat-a, feat-b

```## Gate 3b — Clean-front Optimization



#### Gate Execution- Reordered plan so clean merges come first. Output: `./.smartergpt/deliverables/merge-plan.optimized.json`.

```bash- Order: #17 → #10 → #15 → #16 → #11 → #13 → #12 → #14

$ npm run cli -- gate --plan tests/fixtures/plan.gates.json

## Gate 4 — Remediation Plan (Drafts)

Item feat-a:

  ✓ test-pass (14ms)_Drafted per-PR comments in `.smartergpt/deliverables/comments/`._

  ✗ test-fail (12ms)

    stderr: test failed| PR | Title | Status | Reasons |

|---:|:------|:-------|:--------|

Item feat-b:| #10 | Implement CLI command with --json flag, error handling, and deterministic artifacts | conflict | local gates failing |

  ✓ lint (114ms)| #11 | Implement GitHub query fallback via scope.yml for PR discovery | conflict | local gates failing |

```| #12 | Implement determinism tests and harness with snapshot generation | conflict | local gates failing |

| #13 | Emit plan artifacts (plan.json + snapshot.md) | conflict | draft, local gates failing |

### **Deterministic Ordering Verification**| #14 | Implement dependency DAG builder and levelization with Kahn's algorithm | conflict | draft, local gates failing |

Multiple runs of merge-order produce identical results:| #15 | Implement canonical input loader with precedence for stack.yml, scope.yml, and deps.yml | conflict | draft, local gates failing |

```bash| #16 | Implement MCP tool adapter with plan.create and resource access | conflict | draft, local gates failing |

$ npm run cli -- merge-order --plan tests/fixtures/plan.parallel.json --json| #17 | Implement doctor checks for environment sanity | merged | draft, local gates failing |

{"levels":[["feat-a","feat-b","feat-f"],["feat-c","feat-d"],["feat-e"]]}

# Repeated 5x - identical output every time## Gate 5 — Signal Sync & Owner Handoff

```

- Posted comments: **8** (skipped duplicates: 0)

Within each level, items are sorted alphabetically as expected.- Labeled PRs: **8**

- Conflicts: **7**, Gates failing: **1**, Clean: **0**

## 4. Final Results

## Executive Summary — Gate 6

### **✅ All Acceptance Criteria Met**

**Gate 6 — Integration Branch Summary** (_2025-09-27 19:29:08Z_)

1. **`lex-pr schema validate tests/fixtures/plan.tiny.json` exits 0** ✅

2. **`lex-pr merge-order --plan tests/fixtures/plan.parallel.json --json` returns golden levels** ✅  - Base: **main**

   - Expected: `[["feat-a","feat-b","feat-f"],["feat-c","feat-d"],["feat-e"]]`- Branch: **weave/sprint-20250927T192852Z**

   - Actual: Exact match- Attempted: **8**, Merged cleanly: **1**, Conflicts: **7**

3. **Unknown dependency errors surface with missing names and exit non-zero** ✅- Post-merge gates executed (ruff/mypy/pytest) on the integrated tree.

   - Error: "unknown dependency 'feat-missing' for item 'feat-b'"

4. **Cycle detection errors clearly indicate cycle members** ✅

   - Error: "dependency cycle detected involving: feat-a, feat-b"## Evidence & Verification — Integration Results

5. **Gate execution produces artifacts and correct pass/fail semantics** ✅

   - JSON artifacts written to `--json-dir` when specified| PR | Status | Conflicts | Commit | ruff | mypy | pytest |

   - Exit codes: 0=pass, >0=fail|---:|:-------|:----------|:-------|:-----|:-----|:-------|

6. **All Vitest tests pass locally** ✅| #10 | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts |  | skipped | skipped | skipped |

   - 25/25 tests passing across 3 test suites| #11 | conflict | .smartergpt/deliverables/.live.md |  | skipped | skipped | skipped |

7. **No runtime reads of `.smartergpt/`** ✅  | #12 | conflict | .smartergpt/deliverables/.live.md, src/cli.ts |  | skipped | skipped | skipped |

   - Only `plan.json` consumed by runner| #13 | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts |  | skipped | skipped | skipped |

8. **Output ordering is stable across runs** ✅| #14 | conflict | .smartergpt/deliverables/.live.md, src/cli.ts |  | skipped | skipped | skipped |

   - Deterministic tie-breaking by item name| #15 | conflict | .smartergpt/deliverables/.live.md |  | skipped | skipped | skipped |

| #16 | conflict | .smartergpt/deliverables/.live.md, README.md, src/cli.ts |  | skipped | skipped | skipped |

### **Architecture Compliance**| #17 | merged | — | 8f048ca | skipped | skipped | fail |



- **Two-track separation maintained**: Core runner (`src/`) vs portable profile (`.smartergpt/`)## Final Results — Gate 6

- **Determinism achieved**: Same inputs → identical outputs with stable ordering

- **Privacy-first**: Local-first execution, no secrets in artifacts**Final Results — Gate 6**

- **Schema-driven**: Strict Zod validation with unknown key rejection

- No merges to `main` were performed. If you passed `--push`, CI should be running on the sprint branch.

### **Quality Metrics**- Use this branch for coordination; fix conflicts in the source PRs, then re-run Gates 1–6.


- **Test Coverage**: Comprehensive (schema, DAG, gates, CLI)
- **Error Handling**: Detailed messages with actionable context
- **Performance**: Sub-second gate execution with timeout controls
- **Maintainability**: Modular architecture with focused responsibilities

## 5. Files Changed

### **New Core Modules**
- `src/schema.ts` - Zod schema definition and validation logic
- `src/mergeOrder.ts` - DAG computation with Kahn's algorithm and deterministic ordering
- `src/gates.ts` - Local command execution with timeout, environment, and output capture

### **Updated CLI**
- `src/cli.ts` - Refactored to use modular imports, improved command structure with `--plan` flag support

### **Test Infrastructure**
- `vitest.config.ts` - Vitest configuration for Node environment
- `tests/schema.test.ts` - Schema validation tests (6 tests)
- `tests/mergeOrder.test.ts` - DAG computation tests (7 tests)
- `tests/gates.test.ts` - Gate execution tests (9 tests)

### **Golden Fixtures**
- `tests/fixtures/plan.tiny.json` - Linear 3-node plan
- `tests/fixtures/plan.parallel.json` - 6-node plan with parallel groups
- `tests/fixtures/plan.bad-unknown-dep.json` - Unknown dependency error case
- `tests/fixtures/plan.cycle.json` - Circular dependency error case
- `tests/fixtures/plan.gates.json` - Mixed gate execution scenarios
- `tests/fixtures/plan.bad-schema.json` - Invalid schema error case

### **Package Configuration**
- `package.json` - Added Vitest dependency and test scripts

### **Legacy Preservation**
- `legacy/py-prototype/` - Preserved Python implementation for reference
- `legacy/README.md` - Documentation of migration status

---

## Conclusion

The TypeScript-first lex-pr-runner implementation successfully delivers on the "Gate 0" objectives with a clean, deterministic core that maintains strict two-track separation. The modular architecture, comprehensive test coverage, and adherence to the specified acceptance criteria establish a solid foundation for future development phases.

**Next Recommended Steps:**
1. MCP adapter implementation using the established schemas
2. Hosting adapter for actual git operations
3. Gate result caching and CI dashboard integration
4. Plan generation from `.smartergpt/` workspace files (separate tool)

The implementation is production-ready for the current scope and provides the deterministic foundation required for scaling to higher gates.